<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PERSONNEL REGISTRY | Al-Khat Al-Mudi</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* TACTICAL TERMINAL STYLES */
        body { background-color: #050a15; color: #00f2ff; font-family: 'Share Tech Mono', monospace, sans-serif; margin: 0; padding: 0; transition: all 0.3s ease; }
        body[dir="rtl"] { font-family: 'Cairo', sans-serif; }

        /* --- SIDEBAR LAYOUT --- */
        .admin-wrapper { display: flex; min-height: 100vh; }
        .admin-sidebar { width: 260px; background: rgba(0, 0, 0, 0.6); border-right: 1px solid rgba(0, 242, 255, 0.2); padding: 20px; flex-shrink: 0; display: flex; flex-direction: column; }
        .admin-sidebar-menu { list-style: none; padding: 0; margin: 30px 0 0 0; }
        .admin-sidebar-menu li { margin-bottom: 10px; }
        .admin-sidebar-menu a { display: block; padding: 12px 15px; color: #ccc; text-decoration: none; border-left: 3px solid transparent; transition: all 0.3s ease; font-size: 0.9rem; }
        .admin-sidebar-menu a:hover, .admin-sidebar-menu a.active { background: rgba(0, 242, 255, 0.1); color: #00f2ff; border-left-color: #00f2ff; }
        body[dir="rtl"] .admin-sidebar-menu a { border-left: none; border-right: 3px solid transparent; }
        body[dir="rtl"] .admin-sidebar-menu a:hover, body[dir="rtl"] .admin-sidebar-menu a.active { border-right-color: #00f2ff; }
        .admin-sidebar-menu i { margin-right: 10px; width: 20px; text-align: center; }
        .admin-main-content { flex-grow: 1; padding: 20px 40px; overflow-y: auto; }

        /* --- FORM GRID SYSTEM --- */
        .grid-layout { display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; }
        .panel { border: 1px solid rgba(0, 242, 255, 0.2); background: rgba(0, 242, 255, 0.03); padding: 20px; }
        .panel h3 { margin-top: 0; color: #ff4b5c; border-bottom: 1px solid #ff4b5c; padding-bottom: 10px; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; opacity: 0.8; margin-bottom: 5px; color: #00f2ff; font-weight: bold;}
        input, select, textarea { width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid rgba(0, 242, 255, 0.3); color: white; font-family: inherit; box-sizing: border-box; }
        input:focus, select:focus { border-color: #00f2ff; outline: none; }

        /* --- PHOTO UPLOAD CIRCLE --- */
        .photo-upload-container { text-align: center; margin-bottom: 20px; }
        .photo-preview { width: 100px; height: 100px; border-radius: 50%; border: 2px dashed #00f2ff; margin: 0 auto 10px auto; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; background-size: cover; background-position: center; }
        .photo-preview:hover { background-color: rgba(0, 242, 255, 0.1); }
        .photo-preview i { font-size: 2rem; opacity: 0.5; }

        /* --- FILE DROP ZONES --- */
        .file-drop { border: 1px dashed rgba(0, 242, 255, 0.4); padding: 10px; text-align: center; cursor: pointer; font-size: 0.8rem; color: #888; }
        .file-drop.active { border-color: #00ff88; color: #00ff88; }

        /* --- BUTTONS --- */
        .btn { background: transparent; border: 1px solid #00f2ff; color: #00f2ff; padding: 10px 20px; cursor: pointer; transition: 0.3s; width: 100%; font-weight: bold; font-family: inherit; }
        .btn:hover { background: #00f2ff; color: #050a15; }
        .btn-green { border-color: #00ff88; color: #00ff88; }
        .btn-green:hover { background: #00ff88; color: #000; }
        .btn-danger { border-color: #ff4b5c; color: #ff4b5c; width: auto; font-size: 0.8rem; padding: 5px 10px; }
        .btn-danger:hover { background: #ff4b5c; color: white; }
        .btn-warning { border-color: #ffc107; color: #ffc107; width: auto; padding: 5px 15px;}
        .btn-warning:hover { background: #ffc107; color: #050a15; }

        /* --- EMPLOYEE CARDS --- */
        .emp-card { border: 1px solid rgba(255, 255, 255, 0.1); padding: 15px; margin-bottom: 15px; background: rgba(0,0,0,0.3); display: flex; gap: 15px; align-items: center; }
        .emp-avatar { width: 50px; height: 50px; border-radius: 50%; background: #333; background-size: cover; background-position: center; flex-shrink: 0;}
        .emp-info h4 { margin: 0 0 5px 0; color: white; }
        .emp-info p { margin: 0; font-size: 0.8rem; color: #aaa; }
        .emp-actions { margin-left: auto; display: flex; gap: 5px; flex-direction: column; }
        body[dir="rtl"] .emp-actions { margin-left: 0; margin-right: auto; }

        /* --- DOSSIER VIEW MODAL --- */
        #view-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .dossier-box { border: 1px solid #00f2ff; background: #050a15; padding: 30px; width: 90%; max-width: 500px; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2); }
        .dossier-header { display: flex; gap: 20px; border-bottom: 1px dashed rgba(0,242,255,0.3); padding-bottom: 20px; margin-bottom: 20px; align-items: center; }
        .dossier-photo { width: 80px; height: 80px; border-radius: 50%; border: 2px solid #00f2ff; background-size: cover; background-position: center; flex-shrink: 0;}
        .dossier-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .d-label { font-size: 0.7rem; color: #888; text-transform: uppercase; margin-bottom: 3px; }
        .d-val { font-size: 0.9rem; color: white; margin-bottom: 10px; }
        .d-val.highlight { color: #00ff88; }

        @media (max-width: 900px) {
            .admin-wrapper { flex-direction: column; }
            .admin-sidebar { width: 100%; border-right: none; border-bottom: 1px solid rgba(0, 242, 255, 0.2); }
            .grid-layout { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="admin-wrapper">
        <aside class="admin-sidebar">
            <div style="text-align: center; padding-bottom: 20px; border-bottom: 1px dashed rgba(255,255,255,0.2);">
                <i class="fas fa-shield-alt" style="font-size: 2rem; color: #ff4b5c; margin-bottom: 10px;"></i>
                <h3 style="margin:0; color:white;">ALPHA <span style="color:#00f2ff;">COMMAND</span></h3>
            </div>
            
            <ul class="admin-sidebar-menu">
                <li><a href="alpha.html" class="active"><i class="fas fa-radar"></i> Main Dashboard</a></li>
				<li><a href="admin_deployment.html"><i class="fas fa-rocket"></i> Ad Deployments</a></li>
				<li><a href="employee_reg.html"><i class="fas fa-user-plus"></i> Employee Registry</a></li>
				<li><a href="admin_pricing.html"><i class="fas fa-tags"></i> Pricing & Docs</a></li>
				<li><a href="admin_inbox.html"><i class="fas fa-inbox"></i> Comms & Inbox</a></li>
				<li><a href="admin_logs.html"><i class="fas fa-user-clock"></i> Employee Logs</a></li>
				<li><a href="admin_mail.html"><i class="fas fa-envelope-open-text"></i> Broadcasts</a></li>
				<li><a href="admin_create_products.html"><i class="fas fa-box"></li> Products Page Creator</a></li>
				<li><a href="sales.html"><i class="fas fa-file-invoice-dollar"></i> Sales & Visas</a></li>
            </ul>

            <div style="margin-top: auto; padding-top: 20px;">
                <button onclick="window.location.href='index.html'" class="btn" style="font-size: 0.8rem; width:100%;" id="ui-btn-return">RETURN TO BASE</button>
            </div>
        </aside>

        <main class="admin-main-content">
            <div class="header" style="border-bottom: 1px solid rgba(0, 242, 255, 0.2); padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin:0;" id="ui-header-title"><i class="fas fa-id-card"></i> PERSONNEL REGISTRY COMMAND</h2>
                <button class="btn btn-warning" id="btn-lang" onclick="toggleLanguage()">عربي</button>
            </div>

            <div class="grid-layout">
                <div class="panel">
                    <h3 id="ui-panel1-title"><i class="fas fa-user-edit"></i> NEW OPERATIVE DOSSIER</h3>
                    <form id="emp-form">
                        
                        <div class="photo-upload-container">
                            <input type="file" id="emp-photo" accept="image/*" style="display: none;" onchange="previewPhoto(event)">
                            <div class="photo-preview" id="photo-preview-box" onclick="document.getElementById('emp-photo').click()">
                                <i class="fas fa-camera"></i>
                            </div>
                            <label style="font-size: 0.7rem; color: #aaa;" id="ui-lbl-photo">Click to Upload Photo</label>
                        </div>

                        <div class="form-row">
                            <div><label id="ui-lbl-name">Full Name</label><input type="text" id="emp-name" required></div>
                            <div><label id="ui-lbl-id">Employee ID</label><input type="text" id="emp-id" required placeholder="e.g. AGENT-007"></div>
                        </div>

                        <div class="form-row">
                            <div><label id="ui-lbl-title">Position / Title</label><input type="text" id="emp-title" required></div>
                            <div><label id="ui-lbl-salary">Salary ($)</label><input type="number" id="emp-salary" required></div>
                        </div>

                        <div style="background: rgba(0,0,0,0.3); padding: 10px; margin-bottom: 15px; border-left: 2px solid #ff4b5c;" id="auth-box-border">
                            <label style="color: #ff4b5c;" id="ui-lbl-access">ACCESS CREDENTIALS</label>
                            <div class="form-row" style="margin-bottom:0;">
                                <div><label id="ui-lbl-user">Username</label><input type="text" id="emp-user" required autocomplete="off"></div>
                                <div><label id="ui-lbl-pass">Password</label><input type="text" id="emp-pass" required autocomplete="off"></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div><label id="ui-lbl-reg">Reg. Date</label><input type="date" id="emp-reg-date" required></div>
                            <div>
                                <label id="ui-lbl-perm">Clearance Level</label>
                                <select id="emp-perm">
                                    <option value="Standard" id="ui-opt-std">Standard Operative</option>
                                    <option value="Manager" id="ui-opt-mgr">Field Manager</option>
                                    <option value="Admin" id="ui-opt-admin">Alpha Admin</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div><label id="ui-lbl-start">Contract Start</label><input type="date" id="emp-start"></div>
                            <div><label id="ui-lbl-end">Contract End</label><input type="date" id="emp-end"></div>
                        </div>

                        <div class="form-group">
                            <label id="ui-lbl-address">Home Address (Optional)</label>
                            <input type="text" id="emp-address">
                        </div>

                        <div class="form-row">
                            <div class="file-drop" onclick="document.getElementById('emp-cv').click()">
                                <input type="file" id="emp-cv" style="display: none;" onchange="updateFileLabel('emp-cv', 'lbl-cv')">
                                <i class="fas fa-file-pdf"></i> <span id="lbl-cv">Upload CV</span>
                            </div>
                            <div class="file-drop" onclick="document.getElementById('emp-cert').click()">
                                <input type="file" id="emp-cert" style="display: none;" onchange="updateFileLabel('emp-cert', 'lbl-cert')">
                                <i class="fas fa-certificate"></i> <span id="lbl-cert">Upload Cert</span>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn btn-green" id="btn-submit">REGISTER OPERATIVE</button>
                            <button type="button" class="btn btn-danger" id="btn-cancel" onclick="resetForm()" style="display:none; padding: 10px 20px; font-size:1rem;">CANCEL EDIT</button>
                        </div>
                    </form>
                </div>

                <div class="panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ff4b5c; padding-bottom: 10px; margin-bottom: 15px;">
                        <h3 style="border: none; margin: 0; padding: 0; color: #ff4b5c;" id="ui-panel2-title"><i class="fas fa-users"></i> ACTIVE PERSONNEL</h3>
                        <button class="btn btn-green" style="width: auto; padding: 5px 10px; font-size: 0.8rem;" onclick="exportRosterToCSV()" id="ui-btn-export"><i class="fas fa-file-csv"></i> EXPORT ROSTER</button>
                    </div>
                    <div id="employee-list">
                        <p style="text-align: center; color: gray;" id="ui-msg-scan">Scanning database...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="view-modal">
        <div class="dossier-box">
            <div class="dossier-header">
                <div class="dossier-photo" id="v-photo"></div>
                <div>
                    <h2 style="margin: 0 0 5px 0; color: #00f2ff; letter-spacing: 1px;" id="v-name">NAME</h2>
                    <div class="d-label" style="color: #ff4b5c; font-weight: bold;"><span id="ui-modal-id">ID</span>: <span id="v-id">---</span></div>
                    <div class="d-val" style="margin-bottom: 0;" id="v-title">TITLE</div>
                </div>
            </div>
            
            <div class="dossier-grid">
                <div><div class="d-label" id="ui-modal-user">Username</div><div class="d-val highlight" id="v-user"></div></div>
                <div><div class="d-label" id="ui-modal-perm">Clearance</div><div class="d-val" id="v-perm"></div></div>
                
                <div><div class="d-label" id="ui-modal-salary">Salary</div><div class="d-val" id="v-salary"></div></div>
                <div><div class="d-label" id="ui-modal-reg">Reg. Date</div><div class="d-val" id="v-reg"></div></div>
                
                <div><div class="d-label" id="ui-modal-start">Contract Start</div><div class="d-val" id="v-start"></div></div>
                <div><div class="d-label" id="ui-modal-end">Contract End</div><div class="d-val" id="v-end"></div></div>
                
                <div style="grid-column: span 2;"><div class="d-label" id="ui-modal-address">Address</div><div class="d-val" id="v-address"></div></div>
            </div>

            <div style="border-top: 1px dashed rgba(0,242,255,0.3); padding-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <a href="#" id="v-cv" target="_blank" class="btn btn-green" style="text-align: center; text-decoration: none; display: none; width:calc(50% - 5px); box-sizing:border-box;"><i class="fas fa-file-pdf"></i> <span id="ui-btn-cv">VIEW CV</span></a>
                <a href="#" id="v-cert" target="_blank" class="btn btn-green" style="text-align: center; text-decoration: none; display: none; width:calc(50% - 5px); box-sizing:border-box;"><i class="fas fa-certificate"></i> <span id="ui-btn-cert">VIEW CERT</span></a>
                <a href="#" id="v-email" class="btn btn-green" style="text-align: center; text-decoration: none; margin-top:5px;"><i class="fas fa-envelope"></i> <span id="ui-btn-email">EMAIL OPERATIVE</span></a>
            </div>

            <button class="btn btn-danger" style="margin-top: 20px; width: 100%; padding: 10px; font-size: 1rem;" onclick="closeViewModal()" id="ui-btn-close">CLOSE DOSSIER</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { db, storage, ref, uploadBytes, getDownloadURL, collection, addDoc, doc } from './assets/js/firebase-init.js';
        import { getDocs, deleteDoc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDT5mqFBwSBea1_5RMXv3_59V4Y5LUy5to",
            authDomain: "al-khat-backend.firebaseapp.com",
            projectId: "al-khat-backend",
            storageBucket: "al-khat-backend.firebasestorage.app", 
            messagingSenderId: "310033181926",
            appId: "1:310033181926:web:9a028807fa7c7ab31c5f27"
        };

        const app = getApp(); 
        const auth = getAuth(app);
        const ADMIN_UID = "EOQEt04azKTTWcmNXVtpgSVsRxt2";

        const secondaryApp = initializeApp(firebaseConfig, "Secondary");
        const secondaryAuth = getAuth(secondaryApp);

        let currentEditId = null;
        let globalEmployees = {}; 

        /* ================= BILINGUAL DICTIONARY MATRIX ================= */
        window.currentLang = 'en';
        const dictionary = {
            en: {
                btnReturn: "RETURN TO BASE",
                headerTitle: "<i class='fas fa-id-card'></i> PERSONNEL REGISTRY COMMAND",
                panel1Title: "<i class='fas fa-user-edit'></i> NEW OPERATIVE DOSSIER",
                lblPhoto: "Click to Upload Photo",
                lblName: "Full Name",
                lblId: "Employee ID (e.g. AGENT-007)",
                lblTitle: "Position / Title",
                lblSalary: "Salary ($)",
                lblAccess: "ACCESS CREDENTIALS",
                lblUser: "Username",
                lblPass: "Password",
                lblReg: "Reg. Date",
                lblPerm: "Clearance Level",
                optStd: "Standard Operative",
                optMgr: "Field Manager",
                optAdmin: "Alpha Admin",
                lblStart: "Contract Start",
                lblEnd: "Contract End",
                lblAddress: "Home Address (Optional)",
                lblCv: "Upload CV",
                lblCert: "Upload Cert",
                btnRegister: "REGISTER OPERATIVE",
                btnUpdate: "UPDATE DOSSIER",
                btnCancel: "CANCEL EDIT",
                panel2Title: "<i class='fas fa-users'></i> ACTIVE PERSONNEL",
                btnExport: "<i class='fas fa-file-csv'></i> EXPORT ROSTER",
                msgScan: "Scanning database...",
                msgEmpty: "No personnel found.",
                btnView: "<i class='fas fa-eye'></i> VIEW",
                btnEdit: "<i class='fas fa-edit'></i> EDIT",
                modalId: "ID",
                modUser: "Username",
                modPerm: "Clearance",
                modSalary: "Salary",
                modReg: "Reg. Date",
                modStart: "Contract Start",
                modEnd: "Contract End",
                modAddress: "Address",
                btnModalCv: "VIEW CV",
                btnModalCert: "VIEW CERT",
                btnModalEmail: "EMAIL OPERATIVE",
                btnModalClose: "CLOSE DOSSIER",
                alertProcess: "PROCESSING...",
                alertDel: "WARNING: You are about to terminate this personnel record. Proceed?",
                alertUpdSuccess: "Dossier Updated Successfully.",
                alertNewSuccess: "New Operative Registered & Credentials Generated."
            },
            ar: {
                btnReturn: "العودة للقاعدة الرئيسية",
                headerTitle: "<i class='fas fa-id-card'></i> وحدة قيادة سجل الموظفين",
                panel1Title: "<i class='fas fa-user-edit'></i> ملف موظف جديد",
                lblPhoto: "اضغط لرفع الصورة",
                lblName: "الاسم الكامل",
                lblId: "الرقم الوظيفي (مثال AGENT-007)",
                lblTitle: "المنصب / المسمى الوظيفي",
                lblSalary: "الراتب ($)",
                lblAccess: "بيانات الدخول للنظام",
                lblUser: "اسم المستخدم",
                lblPass: "كلمة المرور",
                lblReg: "تاريخ التسجيل",
                lblPerm: "مستوى الصلاحيات",
                optStd: "موظف قياسي",
                optMgr: "مدير ميداني",
                optAdmin: "مدير نظام",
                lblStart: "بداية العقد",
                lblEnd: "نهاية العقد",
                lblAddress: "عنوان السكن (اختياري)",
                lblCv: "رفع السيرة الذاتية",
                lblCert: "رفع الشهادة",
                btnRegister: "تسجيل الموظف",
                btnUpdate: "تحديث بيانات الموظف",
                btnCancel: "إلغاء التعديل",
                panel2Title: "<i class='fas fa-users'></i> الموظفون الحاليون",
                btnExport: "<i class='fas fa-file-csv'></i> استخراج السجل",
                msgScan: "جاري فحص قاعدة البيانات...",
                msgEmpty: "لا يوجد موظفين مسجلين.",
                btnView: "<i class='fas fa-eye'></i> عرض",
                btnEdit: "<i class='fas fa-edit'></i> تعديل",
                modalId: "الرقم",
                modUser: "اسم المستخدم",
                modPerm: "الصلاحية",
                modSalary: "الراتب",
                modReg: "تاريخ التسجيل",
                modStart: "بداية العقد",
                modEnd: "نهاية العقد",
                modAddress: "العنوان",
                btnModalCv: "عرض السيرة الذاتية",
                btnModalCert: "عرض الشهادة",
                btnModalEmail: "مراسلة الموظف",
                btnModalClose: "إغلاق الملف",
                alertProcess: "جاري المعالجة...",
                alertDel: "تحذير: أنت على وشك إنهاء وحذف ملف هذا الموظف. هل ترغب بالاستمرار؟",
                alertUpdSuccess: "تم تحديث بيانات الموظف بنجاح.",
                alertNewSuccess: "تم تسجيل الموظف وإنشاء بيانات الدخول بنجاح."
            }
        };

        window.toggleLanguage = function() {
            window.currentLang = window.currentLang === 'en' ? 'ar' : 'en';
            const dict = dictionary[window.currentLang];

            // Direction & Buttons
            document.documentElement.lang = window.currentLang;
            document.body.dir = window.currentLang === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('btn-lang').innerText = window.currentLang === 'en' ? 'عربي' : 'English';
            
            // Fix Border RTL Logic for Credentials Box
            document.getElementById('auth-box-border').style.borderLeft = window.currentLang === 'ar' ? 'none' : '2px solid #ff4b5c';
            document.getElementById('auth-box-border').style.borderRight = window.currentLang === 'ar' ? '2px solid #ff4b5c' : 'none';

            // Base UI Labels
            document.getElementById('ui-btn-return').innerText = dict.btnReturn;
            document.getElementById('ui-header-title').innerHTML = dict.headerTitle;
            document.getElementById('ui-panel1-title').innerHTML = dict.panel1Title;
            document.getElementById('ui-lbl-photo').innerText = dict.lblPhoto;
            document.getElementById('ui-lbl-name').innerText = dict.lblName;
            document.getElementById('ui-lbl-id').innerText = dict.lblId;
            document.getElementById('ui-lbl-title').innerText = dict.lblTitle;
            document.getElementById('ui-lbl-salary').innerText = dict.lblSalary;
            document.getElementById('ui-lbl-access').innerText = dict.lblAccess;
            document.getElementById('ui-lbl-user').innerText = dict.lblUser;
            document.getElementById('ui-lbl-pass').innerText = dict.lblPass;
            document.getElementById('ui-lbl-reg').innerText = dict.lblReg;
            document.getElementById('ui-lbl-perm').innerText = dict.lblPerm;
            document.getElementById('ui-opt-std').innerText = dict.optStd;
            document.getElementById('ui-opt-mgr').innerText = dict.optMgr;
            document.getElementById('ui-opt-admin').innerText = dict.optAdmin;
            document.getElementById('ui-lbl-start').innerText = dict.lblStart;
            document.getElementById('ui-lbl-end').innerText = dict.lblEnd;
            document.getElementById('ui-lbl-address').innerText = dict.lblAddress;
            
            if(!document.getElementById('emp-cv').files.length) document.getElementById('lbl-cv').innerText = dict.lblCv;
            if(!document.getElementById('emp-cert').files.length) document.getElementById('lbl-cert').innerText = dict.lblCert;

            document.getElementById('btn-submit').innerText = currentEditId ? dict.btnUpdate : dict.btnRegister;
            document.getElementById('btn-cancel').innerText = dict.btnCancel;
            
            document.getElementById('ui-panel2-title').innerHTML = dict.panel2Title;
            document.getElementById('ui-btn-export').innerHTML = dict.btnExport;

            // Modal UI Labels
            document.getElementById('ui-modal-id').innerText = dict.modalId;
            document.getElementById('ui-modal-user').innerText = dict.modUser;
            document.getElementById('ui-modal-perm').innerText = dict.modPerm;
            document.getElementById('ui-modal-salary').innerText = dict.modSalary;
            document.getElementById('ui-modal-reg').innerText = dict.modReg;
            document.getElementById('ui-modal-start').innerText = dict.modStart;
            document.getElementById('ui-modal-end').innerText = dict.modEnd;
            document.getElementById('ui-modal-address').innerText = dict.modAddress;
            document.getElementById('ui-btn-cv').innerText = dict.btnModalCv;
            document.getElementById('ui-btn-cert').innerText = dict.btnModalCert;
            document.getElementById('ui-btn-email').innerText = dict.btnModalEmail;
            document.getElementById('ui-btn-close').innerText = dict.btnModalClose;

            fetchEmployees(); // Re-render list to translate action buttons
        }

        // --- AUTH & INITIALIZATION ---
        onAuthStateChanged(auth, (user) => {
            if (!user || user.uid !== ADMIN_UID) {
                document.body.innerHTML = "<h1 style='color:red; text-align:center; margin-top:20vh;'>ACCESS DENIED.</h1>";
                setTimeout(() => { window.location.href = "login.html"; }, 2000);
            } else {
                fetchEmployees();
            }
        });

        // --- UI FILE HELPERS ---
        window.previewPhoto = function(e) {
            const file = e.target.files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('photo-preview-box').style.backgroundImage = `url(${e.target.result})`;
                    document.getElementById('photo-preview-box').innerHTML = ""; 
                }
                reader.readAsDataURL(file);
            }
        }

        window.updateFileLabel = function(inputId, labelId) {
            const input = document.getElementById(inputId);
            if(input.files.length > 0) {
                document.getElementById(labelId).innerText = "READY: " + input.files[0].name;
                document.getElementById(labelId).parentElement.classList.add('active');
            }
        }

        // --- SUBMIT / UPDATE DOSSIER ---
        document.getElementById('emp-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            const dict = dictionary[window.currentLang];
            btn.innerText = dict.alertProcess; btn.disabled = true;

            try {
                const email = document.getElementById('emp-user').value + "@alkhat.internal";
                const password = document.getElementById('emp-pass').value;
                
                let photoUrl = "", cvUrl = "", certUrl = "";
                const photoFile = document.getElementById('emp-photo').files[0];
                const cvFile = document.getElementById('emp-cv').files[0];
                const certFile = document.getElementById('emp-cert').files[0];

                if(photoFile) photoUrl = await uploadFile(photoFile, 'photos');
                if(cvFile) cvUrl = await uploadFile(cvFile, 'documents');
                if(certFile) certUrl = await uploadFile(certFile, 'documents');

                const payload = {
                    name: document.getElementById('emp-name').value,
                    empId: document.getElementById('emp-id').value,
                    title: document.getElementById('emp-title').value,
                    salary: document.getElementById('emp-salary').value,
                    username: document.getElementById('emp-user').value,
                    password: password, 
                    regDate: document.getElementById('emp-reg-date').value,
                    permission: document.getElementById('emp-perm').value,
                    contractStart: document.getElementById('emp-start').value,
                    contractEnd: document.getElementById('emp-end').value,
                    address: document.getElementById('emp-address').value,
                    photo: photoUrl, cv: cvUrl, cert: certUrl,
                    timestamp: new Date()
                };

                if (currentEditId) {
                    if(!photoUrl) delete payload.photo;
                    if(!cvUrl) delete payload.cv;
                    if(!certUrl) delete payload.cert;
                    
                    await updateDoc(doc(db, "employees", currentEditId), payload);
                    alert(dict.alertUpdSuccess);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(secondaryAuth, email, password);
                    payload.uid = userCredential.user.uid; 
                    
                    await addDoc(collection(db, "employees"), payload);
                    alert(dict.alertNewSuccess);
                }

                resetForm();
                fetchEmployees();

            } catch (error) {
                console.error(error);
                alert("Operation Failed: " + error.message);
            } finally {
                btn.innerText = currentEditId ? dict.btnUpdate : dict.btnRegister;
                btn.disabled = false;
            }
        });

        async function uploadFile(file, folder) {
            const fileName = Date.now() + "_" + file.name;
            const storageRef = ref(storage, `employee_data/${folder}/${fileName}`);
            await uploadBytes(storageRef, file);
            return await getDownloadURL(storageRef);
        }

        // --- FETCH ROSTER ---
        async function fetchEmployees() {
            const container = document.getElementById('employee-list');
            const dict = dictionary[window.currentLang];
            container.innerHTML = "";
            globalEmployees = {}; 
            
            const q = query(collection(db, "employees"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);

            if(snapshot.empty) { container.innerHTML = `<p style="text-align:center; color:gray;">${dict.msgEmpty}</p>`; return; }

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                globalEmployees[docSnap.id] = data; 
                const photo = data.photo || "https://via.placeholder.com/50";
                
                // Permission translation mappings for the card display
                let dispPerm = data.permission;
                if(window.currentLang === 'ar') {
                    if(dispPerm === "Standard") dispPerm = "موظف قياسي";
                    if(dispPerm === "Manager") dispPerm = "مدير ميداني";
                    if(dispPerm === "Admin") dispPerm = "مدير نظام";
                }

                container.innerHTML += `
                    <div class="emp-card">
                        <div class="emp-avatar" style="background-image: url('${photo}');"></div>
                        <div class="emp-info">
                            <h4>${data.name} <span style="font-size:0.7rem; color:#00f2ff;">[${data.empId}]</span></h4>
                            <p>${data.title} | ${dispPerm}</p>
                            <p style="color:#666;">User: ${data.username}</p>
                        </div>
                        <div class="emp-actions">
                            <button class="btn" style="padding: 5px; font-size: 0.8rem;" onclick="viewEmployee('${docSnap.id}')">${dict.btnView}</button>
                            <button class="btn btn-green" style="padding: 5px; font-size: 0.8rem;" onclick="editEmployee('${docSnap.id}')">${dict.btnEdit}</button>
                            <button class="btn btn-danger" style="padding: 5px; font-size: 0.8rem;" onclick="deleteEmployee('${docSnap.id}')">X</button>
                        </div>
                    </div>
                `;
            });
        }

        // --- DOSSIER VIEW MODAL LOGIC ---
        window.viewEmployee = function(id) {
            const data = globalEmployees[id];
            
            document.getElementById('v-photo').style.backgroundImage = `url('${data.photo || "https://via.placeholder.com/80"}')`;
            document.getElementById('v-name').innerText = data.name;
            document.getElementById('v-id').innerText = data.empId;
            document.getElementById('v-title').innerText = data.title;
            
            document.getElementById('v-user').innerText = data.username;
            
            // Translate Permission inside Modal
            let dispPerm = data.permission;
            if(window.currentLang === 'ar') {
                if(dispPerm === "Standard") dispPerm = "موظف قياسي";
                if(dispPerm === "Manager") dispPerm = "مدير ميداني";
                if(dispPerm === "Admin") dispPerm = "مدير نظام";
            }
            document.getElementById('v-perm').innerText = dispPerm;
            
            document.getElementById('v-salary').innerText = "$" + data.salary;
            document.getElementById('v-reg').innerText = data.regDate;
            document.getElementById('v-start').innerText = data.contractStart || "N/A";
            document.getElementById('v-end').innerText = data.contractEnd || "N/A";
            document.getElementById('v-address').innerText = data.address || (window.currentLang === 'en' ? "No address on file." : "لا يوجد عنوان مسجل.");

            const cvBtn = document.getElementById('v-cv');
            if(data.cv) { cvBtn.style.display = "block"; cvBtn.href = data.cv; } else { cvBtn.style.display = "none"; }

            const certBtn = document.getElementById('v-cert');
            if(data.cert) { certBtn.style.display = "block"; certBtn.href = data.cert; } else { certBtn.style.display = "none"; }
            
            const emailBtn = document.getElementById('v-email');
            const operativeEmail = data.username + "@alkhat.internal"; 
            emailBtn.href = `admin_mail.html?name=${encodeURIComponent(data.name)}&email=${encodeURIComponent(operativeEmail)}`;

            document.getElementById('view-modal').style.display = "flex";
        }

        window.closeViewModal = function() { document.getElementById('view-modal').style.display = "none"; }

        // --- EDITING / CANCEL / DELETE ---
        window.editEmployee = function(id) {
            const data = globalEmployees[id];
            currentEditId = id;
            document.getElementById('emp-name').value = data.name;
            document.getElementById('emp-id').value = data.empId;
            document.getElementById('emp-title').value = data.title;
            document.getElementById('emp-salary').value = data.salary;
            document.getElementById('emp-user').value = data.username;
            document.getElementById('emp-pass').value = data.password;
            document.getElementById('emp-reg-date').value = data.regDate;
            document.getElementById('emp-perm').value = data.permission;
            document.getElementById('emp-start').value = data.contractStart;
            document.getElementById('emp-end').value = data.contractEnd;
            document.getElementById('emp-address').value = data.address;

            const dict = dictionary[window.currentLang];
            const btn = document.getElementById('btn-submit');
            btn.innerText = dict.btnUpdate;
            btn.classList.remove('btn-green');
            document.getElementById('btn-cancel').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.resetForm = function() {
            currentEditId = null;
            document.getElementById('emp-form').reset();
            document.getElementById('photo-preview-box').style.backgroundImage = 'none';
            document.getElementById('photo-preview-box').innerHTML = '<i class="fas fa-camera"></i>';
            document.getElementById('lbl-cv').parentElement.classList.remove('active');
            document.getElementById('lbl-cert').parentElement.classList.remove('active');

            const dict = dictionary[window.currentLang];
            const btn = document.getElementById('btn-submit');
            document.getElementById('lbl-cv').innerText = dict.lblCv;
            document.getElementById('lbl-cert').innerText = dict.lblCert;
            
            btn.innerText = dict.btnRegister;
            btn.classList.add('btn-green');
            document.getElementById('btn-cancel').style.display = 'none';
        }

        window.deleteEmployee = async function(id) {
            const dict = dictionary[window.currentLang];
            if(confirm(dict.alertDel)) {
                await deleteDoc(doc(db, "employees", id));
                fetchEmployees();
            }
        }
        
        // --- CSV EXPORT ---
        window.exportRosterToCSV = function() {
            const employeeIds = Object.keys(globalEmployees);
            if(employeeIds.length === 0) { alert(dictionary[window.currentLang].msgEmpty); return; }

            // 1. Bilingual Headers
            let csvContent = window.currentLang === 'en' ? 
                "Agent ID,Full Name,Title,Clearance,Username,Salary,Reg Date,Contract Start,Contract End\n" : 
                "الرقم الوظيفي,الاسم الكامل,المنصب,الصلاحية,اسم المستخدم,الراتب,تاريخ التسجيل,بداية العقد,نهاية العقد\n";
                
            employeeIds.forEach(id => {
                const data = globalEmployees[id];
                // Translate clearance inside the CSV for Arabic
                let dispPerm = data.permission;
                if(window.currentLang === 'ar') {
                    if(dispPerm === "Standard") dispPerm = "موظف قياسي";
                    if(dispPerm === "Manager") dispPerm = "مدير ميداني";
                    if(dispPerm === "Admin") dispPerm = "مدير نظام";
                }
                
                csvContent += `"${data.empId}","${data.name}","${data.title}","${dispPerm}","${data.username}","${data.salary}","${data.regDate}","${data.contractStart || 'N/A'}","${data.contractEnd || 'N/A'}"\n`;
            });

            // 2. Inject UTF-8 BOM (\uFEFF) to fix Excel Arabic symbols
            const BOM = "\uFEFF";
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Alpha_Roster_${new Date().toLocaleDateString()}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>