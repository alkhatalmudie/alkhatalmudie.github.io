<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEPLOYMENT COMMAND | Al-Khat Al-Mudi</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link rel="stylesheet" href="assets/css/main.css">
	<link rel="stylesheet" href="assets/css/main.css">
    <link rel="icon" type="image/svg+xml" href="images/favicon.svg">
    
    <style>
        /* TACTICAL TERMINAL STYLES */
        body {
            background-color: #050a15;
            color: #00f2ff;
            font-family: 'Share Tech Mono', monospace, sans-serif;
            margin: 0; padding: 0;
            transition: all 0.3s ease;
        }

        /* RTL (Arabic) Support */
        body[dir="rtl"] {
            font-family: 'Cairo', sans-serif;
        }

        /* --- ADMIN DASHBOARD LAYOUT --- */
        .admin-wrapper { display: flex; min-height: 100vh; }
        
        .admin-sidebar {
            width: 260px;
            background: rgba(0, 0, 0, 0.6);
            border-right: 1px solid rgba(0, 242, 255, 0.2);
            padding: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        .admin-sidebar-menu { list-style: none; padding: 0; margin: 30px 0 0 0; }
        .admin-sidebar-menu li { margin-bottom: 10px; }
        .admin-sidebar-menu a {
            display: block; padding: 12px 15px; color: #ccc; text-decoration: none;
            border-left: 3px solid transparent; transition: all 0.3s ease; font-size: 0.9rem;
        }
        .admin-sidebar-menu a:hover, .admin-sidebar-menu a.active {
            background: rgba(0, 242, 255, 0.1); color: #00f2ff; border-left-color: #00f2ff;
        }
        .admin-sidebar-menu i { margin-right: 10px; width: 20px; text-align: center; }

        .admin-main-content {
            flex-grow: 1; padding: 20px 40px; overflow-y: auto;
        }

        .header { 
            border-bottom: 1px solid rgba(0, 242, 255, 0.2); padding-bottom: 20px; 
            margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; 
        }
        
        .grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        
        .panel { border: 1px solid rgba(0, 242, 255, 0.2); background: rgba(0, 242, 255, 0.03); padding: 20px; }
        .panel h3 { margin-top: 0; color: #ff4b5c; border-bottom: 1px solid #ff4b5c; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; opacity: 0.8; margin-bottom: 5px; font-weight: bold; }
        input, textarea { width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid rgba(0, 242, 255, 0.3); color: white; font-family: inherit; box-sizing: border-box; }
        input:focus, textarea:focus { border-color: #00f2ff; outline: none; }
        
        .btn { background: transparent; border: 1px solid #00f2ff; color: #00f2ff; padding: 10px 20px; cursor: pointer; transition: 0.3s; width: 100%; font-family: inherit; font-size: 1rem; font-weight: bold; }
        .btn:hover { background: #00f2ff; color: #050a15; }
        .btn-danger { border-color: #ff4b5c; color: #ff4b5c; width: auto; padding: 5px 10px; font-size: 0.8rem; }
        .btn-danger:hover { background: #ff4b5c; color: white; }
        .btn-warning { border-color: #ffc107; color: #ffc107; width: auto; padding: 10px 20px;}
        .btn-warning:hover { background: #ffc107; color: #050a15; }

        .package-card { border: 1px dashed rgba(0, 242, 255, 0.4); padding: 15px; margin-bottom: 15px; background: rgba(0,0,0,0.4); }
        .package-card h4 { margin: 0 0 10px 0; color: white; }

        @media (max-width: 900px) {
            .admin-wrapper { flex-direction: column; }
            .admin-sidebar { width: 100%; border-right: none; border-bottom: 1px solid rgba(0, 242, 255, 0.2); }
            .grid-layout { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 15px; text-align: center; }
        }
		
		/* --- SYSTEM TRANSITION EFFECTS --- */
		body {
			opacity: 0; /* Start invisible */
			animation: systemBoot 0.4s ease-in forwards; /* Fade in automatically on load */
		}

		@keyframes systemBoot {
			0% { opacity: 0; transform: scale(0.99); }
			100% { opacity: 1; transform: scale(1); }
		}

		/* Class triggered by JS before leaving the page */
		body.system-shutdown {
			opacity: 0 !important;
			transform: scale(0.99);
		}
		
		/* --- SYSTEM LOADER OVERLAY --- */
		.system-loader {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: #050a15; /* Matches your terminal background */
			z-index: 9999; /* Keeps it on top of everything */
			display: flex;
			justify-content: center;
			align-items: center;
			opacity: 0;
			pointer-events: none; /* Lets clicks pass through when hidden */
			transition: opacity 0.3s ease;
		}

		/* When the JS triggers this class, the screen goes black */
		.system-loader.active {
			opacity: 1;
			pointer-events: all; /* Blocks clicks while loading */
		}

		/* The glowing text */
		.loader-text {
			color: #00f2ff;
			font-size: 1.5rem;
			font-family: 'Share Tech Mono', monospace;
			letter-spacing: 5px;
			text-shadow: 0 0 10px rgba(0, 242, 255, 0.8), 0 0 20px rgba(0, 242, 255, 0.4);
			animation: pulseGlow 1.2s infinite alternate;
		}

		/* The blinking dots */
		.loader-text .dots {
			display: inline-block;
			width: 20px;
			text-align: left;
			animation: blinkDots 1.5s infinite steps(4, end);
		}

		/* Keyframes for the neon pulse */
		@keyframes pulseGlow {
			0% { text-shadow: 0 0 5px rgba(0, 242, 255, 0.5); transform: scale(0.98); }
			100% { text-shadow: 0 0 20px rgba(0, 242, 255, 1), 0 0 40px rgba(0, 242, 255, 0.6); transform: scale(1); }
		}

		/* Keyframes for the typewriter dots */
		@keyframes blinkDots {
			0%, 20% { color: transparent; text-shadow: none; }
			40% { color: #00f2ff; text-shadow: 0 0 10px rgba(0, 242, 255, 0.8); }
			100% { color: #00f2ff; text-shadow: 0 0 10px rgba(0, 242, 255, 0.8); }
		}
    </style>
</head>
<body>

    <div id="system-loader" class="system-loader">
		<div class="loader-text">SYSTEM LOADING<span class="dots">...</span></div>
	</div>
	
	<div class="admin-wrapper">
        <aside class="admin-sidebar">
            <div style="text-align: center; padding-bottom: 20px; border-bottom: 1px dashed rgba(255,255,255,0.2);">
            <i class="fas fa-shield-alt" style="font-size: 2.5rem; color: #ff4b5c; margin-bottom: 10px; text-shadow: 0 0 15px rgba(255, 75, 92, 0.4);"></i>
            <h3 style="margin:0; color:white; letter-spacing: 2px;">ALPHA <span style="color:var(--term-cyan);">COMMAND</span></h3>
            <div style="font-size: 0.7rem; color: #888; margin-top: 5px;">SYS.VER 4.0 // ROOT ACCESS</div>
			</div>
                
			<ul class="admin-sidebar-menu">
				<li><a href="alpha.html" class="active"><i class="fas fa-radar"></i> Main Dashboard</a></li>
				<li><a href="admin_deployment.html"><i class="fas fa-rocket"></i> Ad Deployments</a></li>
				<li><a href="employee_reg.html"><i class="fas fa-user-plus"></i> Employee Registry</a></li>
				<li><a href="admin_pricing.html"><i class="fas fa-tags"></i> Pricing & Docs</a></li>
				<li><a href="admin_inbox.html"><i class="fas fa-inbox"></i> Comms & Inbox</a></li>
				<li><a href="admin_logs.html"><i class="fas fa-user-clock"></i> Employee Logs</a></li>
				<li><a href="admin_mail.html"><i class="fas fa-envelope-open-text"></i> Broadcasts</a></li>
				<li><a href="admin_create_products.html"><i class="fas fa-box"></i> Products Page Creator</a></li>
				<li><a href="sales.html"><i class="fas fa-file-invoice-dollar"></i> Sales & Visas</a></li>
			</ul>

            <div style="margin-top: auto; padding-top: 20px;">
                <button onclick="window.location.href='index.html'" class="btn" style="font-size: 0.8rem; width: 100%;" id="ui-btn-return">RETURN TO BASE</button>
            </div>
        </aside>

        <main class="admin-main-content">
            <div class="header">
                <h2 id="ui-header-title" style="margin:0;"><i class="fas fa-rocket"></i> PACKAGE DEPLOYMENT TERMINAL</h2>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-warning" id="btn-lang" onclick="toggleLanguage()">عربي</button>
                </div>
            </div>

            <div class="grid-layout">
                <div class="panel">
                    <h3 id="ui-panel1-title"><i class="fas fa-plus-square"></i> CONSTRUCT NEW PACKAGE</h3>
                    <form id="deploy-form">
                        <div class="form-group">
                            <label id="ui-lbl-name">Operation Name (e.g., Travel to Germany)</label>
                            <input type="text" id="pkg-name" required>
                        </div>
                        <div class="form-group">
                            <label id="ui-lbl-desc">Mission Briefing (Description)</label>
                            <textarea id="pkg-desc" rows="3" required></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group"><label id="ui-lbl-start">Start Date</label><input type="date" id="pkg-start" required></div>
                            <div class="form-group"><label id="ui-lbl-end">End Date</label><input type="date" id="pkg-end" required></div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group"><label id="ui-lbl-old">Original Price ($)</label><input type="number" id="pkg-old-price" required></div>
                            <div class="form-group"><label id="ui-lbl-new">Offer Price ($)</label><input type="number" id="pkg-new-price" required></div>
                        </div>
                        <div class="form-group">
                            <label id="ui-lbl-req">Requirements (Comma separated: Passport, ID, Photos...)</label>
                            <textarea id="pkg-req" rows="2" required></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn" id="btn-deploy">AUTHORIZE DEPLOYMENT</button>
                            <button type="button" class="btn btn-danger" id="btn-cancel" style="display: none; padding: 10px 20px; font-size: 1rem;" onclick="cancelOverride()">ABORT EDIT</button>
                        </div>
                    </form>
                </div>

                <div class="panel">
                    <h3 style="color: #00ff88; border-color: #00ff88;" id="ui-panel2-title"><i class="fas fa-satellite-dish"></i> ACTIVE DEPLOYMENTS</h3>
                    <div id="active-packages">
                        <p id="ui-loading">Scanning frequencies...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDT5mqFBwSBea1_5RMXv3_59V4Y5LUy5to",
            authDomain: "al-khat-backend.firebaseapp.com",
            projectId: "al-khat-backend",
            storageBucket: "al-khat-storage-doha",
            messagingSenderId: "310033181926",
            appId: "1:310033181926:web:9a028807fa7c7ab31c5f27"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN_UID = "EOQEt04azKTTWcmNXVtpgSVsRxt2"; 

        let currentTargetId = null;

        /* =======================================================
           BILINGUAL DICTIONARY MATRIX
           ======================================================= */
        window.currentLang = 'en';
        
        const dictionary = {
            en: {
                header: "<i class='fas fa-rocket'></i> PACKAGE DEPLOYMENT TERMINAL",
                btnReturn: "RETURN TO BASE",
                panel1: "<i class='fas fa-plus-square'></i> CONSTRUCT NEW PACKAGE",
                lblName: "Operation Name (e.g., Travel to Germany)",
                lblDesc: "Mission Briefing (Description)",
                lblStart: "Start Date",
                lblEnd: "End Date",
                lblOld: "Original Price ($)",
                lblNew: "Offer Price ($)",
                lblReq: "Requirements (Comma separated: Passport, ID, Photos...)",
                btnDeploy: "AUTHORIZE DEPLOYMENT",
                btnUpdate: "UPDATE DEPLOYMENT",
                btnCancel: "ABORT EDIT",
                panel2: "<i class='fas fa-satellite-dish'></i> ACTIVE DEPLOYMENTS",
                loading: "Scanning frequencies...",
                empty: "No active promotions.",
                btnOverride: "OVERRIDE",
                btnTerminate: "TERMINATE",
                cardOffer: "Offer:",
                cardWas: "was",
                cardValid: "Valid:"
            },
            ar: {
                header: "<i class='fas fa-rocket'></i> لوحة تحكم نشر الباقات",
                btnReturn: "العودة للقاعدة الرئيسية",
                panel1: "<i class='fas fa-plus-square'></i> إنشاء باقة جديدة",
                lblName: "اسم العملية (مثال: السفر إلى إسبانيا)",
                lblDesc: "تفاصيل المهمة (الوصف المستهدف)",
                lblStart: "تاريخ البدء",
                lblEnd: "تاريخ الانتهاء",
                lblOld: "السعر الأصلي ($)",
                lblNew: "سعر العرض ($)",
                lblReq: "المتطلبات (افصل بينها بفاصلة: جواز سفر، هوية، صور...)",
                btnDeploy: "تصريح النشر الآن",
                btnUpdate: "تحديث بيانات النشر",
                btnCancel: "إلغاء التعديل",
                panel2: "<i class='fas fa-satellite-dish'></i> الباقات الفعالة حالياً",
                loading: "جاري فحص قاعدة البيانات...",
                empty: "لا يوجد باقات فعالة في الوقت الحالي.",
                btnOverride: "تعديل",
                btnTerminate: "إنهاء وحذف",
                cardOffer: "العرض:",
                cardWas: "بدلًا من",
                cardValid: "صالح من:"
            }
        };

        window.toggleLanguage = function() {
            window.currentLang = window.currentLang === 'en' ? 'ar' : 'en';
            const lang = window.currentLang;
            const dict = dictionary[lang];

            // Toggle Direction & Font
            document.documentElement.lang = lang;
            document.body.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.getElementById('btn-lang').innerText = lang === 'en' ? 'عربي' : 'English';

            // Apply Dictionary
            document.getElementById('ui-header-title').innerHTML = dict.header;
            document.getElementById('ui-btn-return').innerText = dict.btnReturn;
            document.getElementById('ui-panel1-title').innerHTML = dict.panel1;
            document.getElementById('ui-lbl-name').innerText = dict.lblName;
            document.getElementById('ui-lbl-desc').innerText = dict.lblDesc;
            document.getElementById('ui-lbl-start').innerText = dict.lblStart;
            document.getElementById('ui-lbl-end').innerText = dict.lblEnd;
            document.getElementById('ui-lbl-old').innerText = dict.lblOld;
            document.getElementById('ui-lbl-new').innerText = dict.lblNew;
            document.getElementById('ui-lbl-req').innerText = dict.lblReq;
            document.getElementById('ui-panel2-title').innerHTML = dict.panel2;
            
            // Adjust buttons based on state
            document.getElementById('btn-deploy').innerText = currentTargetId ? dict.btnUpdate : dict.btnDeploy;
            document.getElementById('btn-cancel').innerText = dict.btnCancel;

            // Re-render packages to translate dynamic buttons and text
            fetchPackages();
        }

        /* =======================================================
           FIREBASE ENGINE
           ======================================================= */
        onAuthStateChanged(auth, (user) => {
            if (!user || user.uid !== ADMIN_UID) {
                document.body.innerHTML = "<h1 style='color:red; text-align:center; margin-top:20vh;'>ACCESS DENIED.</h1>";
                setTimeout(() => { window.location.href = "login.html"; }, 2000);
            } else {
                fetchPackages();
            }
        });

        document.getElementById('deploy-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-deploy');
            btn.innerText = "TRANSMITTING..."; btn.disabled = true;

            const payload = {
                name: document.getElementById('pkg-name').value,
                desc: document.getElementById('pkg-desc').value,
                startDate: document.getElementById('pkg-start').value,
                endDate: document.getElementById('pkg-end').value,
                oldPrice: document.getElementById('pkg-old-price').value,
                newPrice: document.getElementById('pkg-new-price').value,
                reqs: document.getElementById('pkg-req').value
            };

            try {
                if (currentTargetId) {
                    await updateDoc(doc(db, "promotions", currentTargetId), payload);
                    alert(window.currentLang === 'en' ? "Operation parameters updated successfully." : "تم تحديث بيانات العملية بنجاح.");
                } else {
                    payload.timestamp = new Date(); 
                    await addDoc(collection(db, "promotions"), payload);
                }
                
                cancelOverride();
                fetchPackages();
            } catch (error) { 
                alert("Error: " + error.message); 
                btn.innerText = currentTargetId ? dictionary[window.currentLang].btnUpdate : dictionary[window.currentLang].btnDeploy;
                btn.disabled = false;
            }
        });

        async function fetchPackages() {
            const container = document.getElementById('active-packages');
            const dict = dictionary[window.currentLang];
            container.innerHTML = "";
            
            const q = query(collection(db, "promotions"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);

            if(snapshot.empty) { container.innerHTML = `<p>${dict.empty}</p>`; return; }

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                container.innerHTML += `
                    <div class="package-card">
                        <h4>${data.name}</h4>
                        <p style="font-size:0.8rem; margin: 5px 0;">${dict.cardOffer} $${data.newPrice} (${dict.cardWas} <strike>$${data.oldPrice}</strike>)</p>
                        <p style="font-size:0.8rem; color:gray;">${dict.cardValid} ${data.startDate} ➝ ${data.endDate}</p>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn" style="width: auto; padding: 5px 10px; font-size: 0.8rem; border-color: #00ff88; color: #00ff88;" onclick="overridePackage('${docSnap.id}')">${dict.btnOverride}</button>
                            <button class="btn btn-danger" onclick="deletePackage('${docSnap.id}')">${dict.btnTerminate}</button>
                        </div>
                    </div>
                `;
            });
        }

        window.overridePackage = async function(id) {
            const docRef = doc(db, "promotions", id);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                document.getElementById('pkg-name').value = data.name;
                document.getElementById('pkg-desc').value = data.desc;
                document.getElementById('pkg-start').value = data.startDate;
                document.getElementById('pkg-end').value = data.endDate;
                document.getElementById('pkg-old-price').value = data.oldPrice;
                document.getElementById('pkg-new-price').value = data.newPrice;
                document.getElementById('pkg-req').value = data.reqs;

                currentTargetId = id;
                const dict = dictionary[window.currentLang];
                
                document.getElementById('btn-deploy').innerText = dict.btnUpdate;
                document.getElementById('btn-deploy').style.borderColor = "#00ff88";
                document.getElementById('btn-deploy').style.color = "#00ff88";
                document.getElementById('btn-cancel').style.display = "block";
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        window.cancelOverride = function() {
            currentTargetId = null;
            document.getElementById('deploy-form').reset();
            
            const btn = document.getElementById('btn-deploy');
            btn.innerText = dictionary[window.currentLang].btnDeploy;
            btn.disabled = false;
            btn.style.borderColor = "#00f2ff";
            btn.style.color = "#00f2ff";
            
            document.getElementById('btn-cancel').style.display = "none";
        }

        window.deletePackage = async function(id) {
            const msg = window.currentLang === 'en' ? "Are you sure you want to terminate this package?" : "هل أنت متأكد من رغبتك في حذف هذه الباقة؟";
            if(confirm(msg)) {
                await deleteDoc(doc(db, "promotions", id));
                fetchPackages();
            }
        }
    </script>
	<script>
		document.addEventListener("DOMContentLoaded", () => {
			// --- 1. AUTOMATIC ACTIVE MENU HIGHLIGHTING ---
			let currentPath = window.location.pathname.split('/').pop(); 
			if (currentPath === '') currentPath = 'admin_dashboard.html'; // Or employee_dashboard.html depending on the page

			const menuLinks = document.querySelectorAll('.admin-sidebar-menu a, .dash-sidebar a');
			
			menuLinks.forEach(link => {
				const linkHref = link.getAttribute('href');
				if (linkHref === currentPath) {
					link.classList.add('active');
				}
			});

			// --- 2. SYSTEM LOADER TRANSITIONS ---
			menuLinks.forEach(link => {
				link.addEventListener('click', function(e) {
					const targetUrl = this.getAttribute('href');
					if (!targetUrl || targetUrl === '#' || targetUrl.startsWith('javascript')) return;

					e.preventDefault(); // Stop the hard jump
					
					// Grab the loader and fade it in
					const loader = document.getElementById('system-loader');
					if (loader) {
						loader.classList.add('active');
					}
					
					// Wait 500ms to show the cool animation, then load the next page
					setTimeout(() => {
						window.location.href = targetUrl;
					}, 500); 
				});
			});
		});
	</script>
</body>
</html>