<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation & Booking | Al-Khat Al-Mudi</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="icon" type="image/svg+xml" href="images/favicon.svg">

    <style>
        /* HEADER CLEARANCE FIX */
        body {
            padding-top: 80px;
        }

        /* 1. DARK MAP STAGE (DIMMED MODE) */
        /* 1. DARK MAP STAGE (REVERTED TO OLD STYLE) */
		.map-stage {
			position: relative;
			width: 100%;
			height: 100%;
			background-image: 
				linear-gradient(rgba(15, 24, 46, 0.4), rgba(15, 24, 46, 0.4)),
				url('https://upload.wikimedia.org/wikipedia/commons/8/80/World_map_-_low_resolution.svg');
			background-size: cover; /* Back to your original style! */
			background-position: center;
			transform-origin: center center;
			will-change: transform;
			cursor: grab;
		}

		.map-stage:active {
			cursor: grabbing;
		}

		/* (Keep your original .map-dot, .dot-pulse, and .dot-label CSS exactly as they are!) */

        /* 2. THE INTERACTIVE DOTS (NEON STYLE) */
        .map-point {
            position: absolute;
            width: 16px; height: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--brand-cyan); /* Cyan Border */
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 10px rgba(0, 174, 239, 0.3);
        }

        /* Hover & Active States */
        .map-point:hover, .map-point.active {
            background: var(--brand-magenta); /* Turns Magenta */
            border-color: white;
            transform: scale(1.4);
            z-index: 20;
            box-shadow: 0 0 20px var(--brand-magenta); /* Glowing Effect */
        }

        /* The Ripple Effect (Only on Hover/Active) */
        .map-point::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            border: 1px solid var(--brand-magenta);
            border-radius: 50%;
            opacity: 0;
            transition: 0.3s;
        }

        .map-point:hover::before, .map-point.active::before {
            animation: ripple 1.5s infinite;
            opacity: 1;
        }

        @keyframes ripple {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(3); opacity: 0; }
        }

        /* 3. THE INFO PANEL (Hidden by Default) */
        .location-card {
            position: absolute;
            bottom: 35px; left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: rgba(255, 255, 255, 0.95); /* Glassy White */
            padding: 15px 20px;
            border-radius: 12px;
            width: 220px;
            text-align: center;
            opacity: 0;
            pointer-events: none; /* Can't click when hidden */
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border-top: 3px solid var(--brand-magenta);
            z-index: 100;
        }

        /* Show Panel ONLY on Hover or Active */
        .map-point:hover .location-card,
        .map-point.active .location-card {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: all;
        }

        .location-card h4 { color: var(--brand-navy); margin-bottom: 5px; font-weight: 700; font-size: 1.1rem; }
        .location-card p { color: #555; font-size: 0.85rem; margin-bottom: 10px; }
        
        .btn-select-loc {
            background: var(--brand-navy);
            color: white;
            font-size: 0.8rem;
            padding: 6px 15px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
        }
        .btn-select-loc:hover { background: var(--brand-cyan); }

        /* BOOKING WIZARD STYLES */
        .booking-section { padding: 80px 0; background: var(--bg-body); }
        .booking-card {
            background: white; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.05);
            overflow: hidden; display: grid; grid-template-columns: 1.5fr 1fr;
        }
        .booking-form { padding: 40px; }
        .booking-summary { background: var(--brand-navy); color: white; padding: 40px; display: flex; flex-direction: column; justify-content: space-between; }
        .price-display { font-size: 3rem; font-weight: 900; color: var(--brand-cyan); font-family: var(--font-primary); }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }

        @media (max-width: 992px) { .booking-card { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header>
			<div class="container">
				<nav class="navbar">
					<a href="index.html" class="logo-box" style="text-decoration: none;">
						<div class="dna-logo">
							<div class="dna-drop dna-magenta"></div>
							<div class="dna-drop dna-cyan"></div>
						</div>
						<div class="brand-text">
							<h3>Al-Khat Al-Mudi</h3>
							<span id="header-brand_sub">TRANSLATION SERVICES</span>
						</div>
					</a>
					
					<div id="user-profile-section" class="user-status-hidden">
						<a href="profile.html" class="user-orb">
							<i class="fas fa-user-circle"></i>
							<span id="user-display-name">Client</span>
						</a>
						<button onclick="handleLogout()" class="logout-link">Logout</button>
					</div>
					
					<a href="#menu" class="menu-toggle" id="menuToggle">
						<span class="text" id="header-menu_btn">MENU</span>
						<div class="hamburger">
							<span></span>
							<span></span>
							<span></span>
						</div>
					</a>
					
				</nav>
			</div>
		</header>

    <div style="overflow: hidden; position: relative; width: 100%; height: 650px; background-color: #0f182e;">
		<div class="map-stage" id="map-stage">
			
			<div class="map-instructions" data-i18n="res_map_inst" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 50; color: rgba(255,255,255,0.7); background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px; font-size: 0.85rem;">
				<i class="fas fa-crosshairs"></i> Scroll to Zoom | Drag to Pan
			</div>

			<div class="map-dot" style="top: 45%; left: 56.5%;" onclick="selectLocation('Amman Base', 'JO', this)">
				<div class="dot-pulse"></div>
				<div class="dot-label" data-i18n="res_loc_amman">Amman Base</div>
			</div>
			<div class="map-dot" style="top: 25%; left: 57%;" onclick="selectLocation('Moscow Node', 'RU', this)">
				<div class="dot-pulse"></div>
				<div class="dot-label" data-i18n="res_loc_moscow">Moscow Node</div>
			</div>
			<div class="map-dot" style="top: 30%; left: 47%;" onclick="selectLocation('London HQ', 'GB', this)">
				<div class="dot-pulse"></div>
				<div class="dot-label" data-i18n="res_loc_london">London HQ</div>
			</div>
			<div class="map-dot" style="top: 28%; left: 48.5%;" onclick="selectLocation('Amsterdam Link', 'NL', this)">
				<div class="dot-pulse"></div>
				<div class="dot-label" data-i18n="res_loc_amsterdam">Amsterdam Link</div>
			</div>
			<div class="map-dot" style="top: 50%; left: 61%;" onclick="selectLocation('Dubai Hub', 'AE', this)">
				<div class="dot-pulse"></div>
				<div class="dot-label" data-i18n="res_loc_dubai">Dubai Hub</div>
			</div>
		</div>
	</div>

    <section class="booking-section">
        <div class="container">
            <div class="booking-card">
                
                <div class="booking-form">
                    <h2 class="section-title">Step 2: Document Details</h2>
                    
                    <form id="calcForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label style="font-weight:bold; color:var(--brand-navy); display:block; margin-bottom:5px;">Translate From</label>
                                <select class="glass-input" id="langFrom">
                                    <option value="en">English</option>
                                    <option value="ar">Arabic</option>
                                    <option value="ru">Russian</option>
                                    <option value="de">German</option>
                                    <option value="nl">Dutch</option>
                                    <option value="fr">French</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="font-weight:bold; color:var(--brand-navy); display:block; margin-bottom:5px;">Translate To</label>
                                <select class="glass-input" id="langTo">
                                    <option value="ar">Arabic</option>
                                    <option value="en">English</option>
                                    <option value="ru">Russian</option>
                                    <option value="de">German</option>
                                    <option value="nl">Dutch</option>
                                    <option value="fr">French</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 20px;">
                            <label style="font-weight:bold; color:var(--brand-navy); display:block; margin-bottom:5px;">Document Type</label>
                            <select class="glass-input" id="docType" onchange="calculatePrice()">
                                <option value="" disabled selected>Loading Documents...</option>
                            </select>
                        </div>

                        <div class="form-row" style="margin-top: 20px;">
                            <div class="form-group">
                                <label style="font-weight:bold; color:var(--brand-navy); display:block; margin-bottom:5px;">Page Count</label>
                                <input type="number" id="pageCount" class="glass-input" value="1" min="1" onchange="calculatePrice()" oninput="calculatePrice()">
                            </div>
                            <div class="form-group">
                                <label style="font-weight:bold; color:var(--brand-navy); display:block; margin-bottom:5px;">Service Level</label>
                                <select class="glass-input" id="urgency" onchange="calculatePrice()">
                                    <option value="1">Standard (48h)</option>
                                    <option value="1.5">Express (24h) [+50%]</option>
                                    <option value="2">Immediate (Same Day) [+100%]</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="booking-summary">
                    <div>
                        <h3 style="margin-bottom: 30px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px;">Order Summary</h3>
                        
                        <div class="summary-row">
                            <span>Selected Office:</span>
                            <span id="summaryLocation" style="color: var(--brand-cyan); font-weight: bold; font-size: 1.1rem;">--</span>
                        </div>
                        <div class="summary-row">
                            <span>Document:</span>
                            <span id="summaryDoc">--</span>
                        </div>
                        <div class="summary-row">
                            <span>Pages:</span>
                            <span id="summaryPages">1</span>
                        </div>
                        <div class="summary-row">
                            <span>Fees:</span>
                            <span id="summaryFees">0.00 JOD</span>
                        </div>
                    </div>

                    <div>
                        <div style="text-align: right; margin-bottom: 20px;">
                            <span style="display: block; font-size: 0.9rem; opacity: 0.7;">Estimated Total</span>
                            <span class="price-display" id="totalPrice">0.00</span> <span style="font-size: 1.5rem;">JOD</span>
                        </div>
                        <button onclick="proceedToCheckout()" class="btn btn-primary" style="width: 100%; background: white; color: var(--brand-navy);">
                            Proceed to Checkout <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </section>
	
	<div id="side-menu" class="menu-panel">
        <a href="javascript:void(0)" class="close-btn" id="closeMenu">&times;</a>

        <div class="menu-content">
            <h4 class="menu-label" id="menu-label_nav">NAVIGATION</h4>
            <ul class="main-links">
                <li><a href="index.html" id="menu-home">Home</a></li>
                <li class="dropdown-trigger">
                    <a href="javascript:void(0)"><span id="menu-pages">Pages</span> <i class="fas fa-chevron-down"></i></a>
                    <ul class="dropdown-list">
                        <li><a href="about.html" id="menu-about">About Us</a></li>
                        <li><a href="services.html" id="menu-services">Services</a></li>
                        <li><a href="translation.html" id="menu-translation">Translation Info</a></li>
                        <li><a href="packages.html" id="menu-packages">Packages & Pricing</a></li>
                        <li><a href="shop.html" id="menu-shop">Shop / Products</a></li>
                        <li><a href="reservation.html" id="menu-reservation">Book Reservation</a></li>
                        <li><a href="contacts.html" id="menu-contact">Contact Us</a></li>
                    </ul>
                </li>
            </ul>

            <h4 class="menu-label" id="menu-label_member">MEMBER AREA</h4>
            <div class="auth-buttons">
                <a href="login.html" class="btn-auth login" id="menu-login">Log In</a>
                <a href="signup.html" class="btn-auth signup" id="menu-signup">Sign Up</a>
            </div>

            <h4 class="menu-label" id="menu-label_region">REGION SELECT</h4>
            <div class="lang-grid">
                <a href="javascript:void(0)" onclick="switchLanguage('en')" class="lang-orb" title="English"><img src="images/GB.png" alt="English"></a>
                <a href="javascript:void(0)" onclick="switchLanguage('ar')" class="lang-orb" title="Arabic"><img src="images/Ar.png" alt="Arabic"></a>
                <a href="javascript:void(0)" onclick="switchLanguage('du')" class="lang-orb" title="Dutch"><img src="images/Du.png" alt="Dutch"></a>
                <a href="javascript:void(0)" onclick="switchLanguage('ru')" class="lang-orb" title="Russian"><img src="images/Ru.png" alt="Russian"></a>
            </div>
        </div>
    </div>

	<script src="assets/js/main.js"></script>
	<script src="assets/js/lang-engine.js"></script>
	
	<script type="module">
        import { db } from './assets/js/firebase-init.js';
        import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // We still keep locations static since they are tied to hardcoded CSS coordinates on the map
        const STATIC_LOCATIONS = [
            { id: "jo", name: "Amman Base", phone: "+962 78 077 0085" },
            { id: "ru", name: "Moscow Node", phone: "+7 495 123-45-67" },
            { id: "gb", name: "London HQ", phone: "+44 20 7946 0123" },
            { id: "nl", name: "Amsterdam Link", phone: "+31 20 123 4567" },
            { id: "ae", name: "Dubai Hub", phone: "+971 50 123 4567" }
        ];

        let DYNAMIC_DB = { rates: { base_per_page: 10.00 }, documents: [] };

        // 1. FETCH PRICING FROM FIREBASE
        async function fetchPricingConfig() {
            try {
                const docSnap = await getDoc(doc(db, "system_config", "pricing"));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    DYNAMIC_DB.rates.base_per_page = data.base_per_page;
                    DYNAMIC_DB.documents = data.documents || [];
                    populateDocumentDropdown();
                }
            } catch (error) {
                console.error("Failed to fetch dynamic pricing. Defaulting to safe values.", error);
            }
        }

        function populateDocumentDropdown() {
            const docSelect = document.getElementById('docType');
            docSelect.innerHTML = ""; 
            DYNAMIC_DB.documents.forEach(docItem => {
                const opt = document.createElement('option');
                opt.value = docItem.id;
                opt.innerText = docItem.label;
                opt.dataset.price = docItem.price_mod;
                docSelect.appendChild(opt);
            });
            window.calculatePrice(); // Trigger recalculation with new data
        }

        // Initialize Fetch
        fetchPricingConfig();

        // 2. REVERTED MAP ZOOM & PAN ENGINE
        const mapStage = document.getElementById('map-stage');
        let scale = 1, panning = false, pointX = 0, pointY = 0, startX = 0, startY = 0;

        function setTransform() { mapStage.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }

        mapStage.addEventListener('wheel', (e) => {
            e.preventDefault(); 
            const zoomSensitivity = 0.15;
            const delta = e.deltaY < 0 ? 1 : -1;
            scale += delta * zoomSensitivity;
            scale = Math.min(Math.max(1, scale), 4);
            if(scale === 1) { pointX = 0; pointY = 0; }
            setTransform();
        }, { passive: false });

        mapStage.addEventListener('mousedown', (e) => {
            if(scale > 1) {
                e.preventDefault();
                panning = true;
                startX = e.clientX - pointX;
                startY = e.clientY - pointY;
            }
        });

        mapStage.addEventListener('mousemove', (e) => {
            if (!panning) return;
            e.preventDefault();
            pointX = e.clientX - startX;
            pointY = e.clientY - startY;
            setTransform();
        });

        mapStage.addEventListener('mouseup', () => { panning = false; });
        mapStage.addEventListener('mouseleave', () => { panning = false; });

        // 3. LOCATION SELECTION
        let selectedLocName = "";
        window.selectLocation = function(name, countryCode, element) {
            document.querySelectorAll('.map-point').forEach(el => el.classList.remove('active'));
            if(element.classList.contains('map-point')) element.classList.add('active');
            
            selectedLocName = name;
            const summaryLoc = document.getElementById('summaryLocation');
            summaryLoc.innerText = name;
            summaryLoc.style.color = "white";
            setTimeout(() => { summaryLoc.style.color = "var(--brand-cyan)"; }, 300);
        }

        // 4. CALCULATOR LOGIC (NOW USING DYNAMIC_DB)
        window.calculatePrice = function() {
            const pages = parseInt(document.getElementById('pageCount').value) || 1;
            const urgency = parseFloat(document.getElementById('urgency').value);
            const docSelect = document.getElementById('docType');
            const docOption = docSelect.options[docSelect.selectedIndex];
            
            if(!docOption) return;

            const docFactor = parseFloat(docOption.dataset.price);
            const baseRate = DYNAMIC_DB.rates.base_per_page;
            const total = (baseRate * docFactor * pages * urgency);
            
            document.getElementById('summaryDoc').innerText = docOption.text;
            document.getElementById('summaryPages').innerText = pages;
            document.getElementById('totalPrice').innerText = total.toFixed(2);
        }

        // 5. CHECKOUT LOGIC
        window.proceedToCheckout = function() {
            if(!selectedLocName) {
                alert("Please select a region from the map first!");
                return;
            }

            const docSelect = document.getElementById('docType');
            const params = new URLSearchParams({
                loc: selectedLocName,
                from: document.getElementById('langFrom').value,
                to: document.getElementById('langTo').value,
                doc: docSelect.options[docSelect.selectedIndex].text,
                pages: document.getElementById('pageCount').value,
                urgency: document.getElementById('urgency').options[document.getElementById('urgency').selectedIndex].text,
                price: document.getElementById('totalPrice').innerText + " JOD"
            });

            window.location.href = 'checkout.html?' + params.toString();
        }
    </script>
</body>
</html>