<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Invoice | Al-Khat Al-Mudi</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="icon" type="image/svg+xml" href="images/favicon.svg">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { padding-top: 40px; background: #f0f4f8; font-family: 'Poppins', sans-serif; }
        
        .invoice-container {
            max-width: 800px;
            margin: 0 auto 40px auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 40px;
            position: relative;
        }

        /* HEADER */
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #eee;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .invoice-logo .dna-logo { transform: scale(0.8); transform-origin: left; }
        .invoice-title { font-size: 2rem; font-weight: 900; color: var(--brand-navy); margin: 0; }
        .invoice-status {
            background: rgba(46, 204, 113, 0.1);
            color: #2ecc71;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.85rem;
            display: inline-block;
            margin-top: 10px;
            border: 1px solid #2ecc71;
        }

        /* GRID INFO */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .info-box h4 { font-size: 0.85rem; color: #888; text-transform: uppercase; margin: 0 0 5px 0; }
        .info-box p { font-size: 1rem; color: var(--brand-navy); font-weight: 600; margin: 0; }

        /* TABLE */
        .invoice-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .invoice-table th { text-align: left; padding: 15px; background: var(--brand-navy); color: white; font-size: 0.9rem; }
        .invoice-table td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.95rem; color: #444; }
        
        .totals-box { width: 300px; float: right; }
        .total-row { display: flex; justify-content: space-between; padding: 10px 0; font-size: 1.1rem; }
        .total-row.grand-total { border-top: 2px solid var(--brand-navy); font-size: 1.5rem; font-weight: 800; color: var(--brand-cyan); margin-top: 10px; padding-top: 15px; }

        /* ACTION BUTTONS (Hidden during print/PDF generation) */
        .action-bar {
            max-width: 800px;
            margin: 0 auto 20px auto;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        .btn-action {
            background: white; border: 1px solid #ccc; padding: 10px 20px; border-radius: 8px; cursor: pointer;
            font-weight: bold; color: var(--brand-navy); transition: 0.3s;
        }
        .btn-action:hover { background: #eee; }
        .btn-action.primary { background: var(--brand-cyan); color: white; border: none; }
        .btn-action.primary:hover { background: #00b3cc; }

        /* Hide specific elements when printing to PDF */
        .html2pdf__container .action-bar { display: none !important; }
    </style>
</head>
<body>

    <div class="action-bar" id="ui-actions">
        <button class="btn-action" id="btn-lang" onclick="toggleInvoiceLanguage()" style="border-color: #ffc107; color: #ffc107;">عربي</button>
        
        <button onclick="window.print()" class="btn-action"><i class="fas fa-print"></i> Print</button>
        <button onclick="downloadSecurePDF()" class="btn-action primary" id="btn-pdf"><i class="fas fa-file-pdf"></i> Download Secure PDF</button>
    </div>

    <div class="invoice-container" id="invoice-paper">
        <div class="invoice-header">
            <div class="invoice-logo">
                <div class="dna-logo" style="margin-bottom: 10px;">
                    <div class="dna-drop dna-magenta"></div>
                    <div class="dna-drop dna-cyan"></div>
                </div>
                <h3 style="margin:0; color: var(--brand-navy);">Al-Khat Al-Mudi</h3>
                <p style="margin:0; font-size: 0.8rem; color: #888;">Amman, Jordan - Global Dispatch</p>
            </div>
            <div style="text-align: right;">
                <h1 class="invoice-title" id="ui-inv-title">INVOICE</h1>
                <div class="invoice-status" id="ui-inv-status"><i class="fas fa-check"></i> PAID SECURELY</div>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-box">
                <h4 id="ui-lbl-to">Invoice To</h4>
                <p id="client_name">Scanning Identity...</p>
                <span id="client_email" style="font-size: 0.85rem; color: #666;">--</span>
            </div>
            <div class="info-box" style="text-align: right;">
                <h4 id="ui-lbl-details">Invoice Details</h4>
                <p><span id="ui-lbl-ref">REF:</span> <span id="inv_ref">--</span></p>
				<p><span id="ui-lbl-date">Date:</span> <span id="inv_date">--</span></p>
                <p>TXN ID: <span id="txn_id">--</span></p>
            </div>
        </div>

        <table class="invoice-table">
            <thead>
                <tr>
					<th id="ui-th-desc">Description</th>
					<th id="ui-th-lang">Languages / Region</th>
					<th id="ui-th-pages">Pages</th>
					<th style="text-align: right;" id="ui-th-total">Total Amount</th>
				</tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <strong id="item_desc">--</strong><br>
                        <span style="font-size: 0.8rem; color: #888;" id="item_urgency">--</span>
                    </td>
                    <td id="item_detail">--</td>
                    <td id="item_pages">--</td>
                    <td style="text-align: right; font-weight: bold;" id="item_price">0.00 JOD</td>
                </tr>
            </tbody>
        </table>

        <div style="display: flex; justify-content: space-between; align-items: flex-end;">
            <div id="qrcode"></div>
            
            <div class="totals-box">
                <div class="total-row grand-total">
                    <span>Total Paid</span>
                    <span id="total_amount">0.00 JOD</span>
                </div>
            </div>
        </div>
        
        <div id="ui-inv-footer" style="margin-top: 50px; font-size: 0.75rem; color: #aaa; text-align: center; border-top: 1px solid #eee; padding-top: 20px;">
			This is a computer-generated document. No signature is required.<br>
			Encrypted by Alpha Command Security Matrix.
		</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDT5mqFBwSBea1_5RMXv3_59V4Y5LUy5to",
            authDomain: "al-khat-backend.firebaseapp.com",
            projectId: "al-khat-backend",
            storageBucket: "al-khat-backend.firebasestorage.app", // <--- THE CORRECT UPLINK
            messagingSenderId: "310033181926",
            appId: "1:310033181926:web:9a028807fa7c7ab31c5f27"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make this globally accessible for the PDF Generator
        window.invoiceDataStore = {}; 

        async function loadInvoice() {
            const urlParams = new URLSearchParams(window.location.search);
            const invoiceId = urlParams.get('id');

            if (!invoiceId) {
                document.body.innerHTML = "<h1 style='color:var(--brand-navy);text-align:center;margin-top:100px;'>No ID Provided.</h1>";
                return;
            }

            // READ FROM FIREBASE
            const docRef = doc(db, "orders", invoiceId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Store data globally to use later for generating the PDF File Name
                window.invoiceDataStore = data;

                // FILL UI
                document.getElementById('inv_ref').innerText = '#' + data.invoiceId;
                document.getElementById('client_name').innerText = data.clientName || "GUEST VISITOR";
                document.getElementById('client_email').innerText = data.clientEmail || "Unregistered";
                
                // Format Date nicely
                const dateObj = data.timestamp ? data.timestamp.toDate() : new Date();
                document.getElementById('inv_date').innerText = dateObj.toLocaleDateString();
                
                document.getElementById('txn_id').innerText = data.transactionId;

                document.getElementById('item_desc').innerText = data.docType;
                document.getElementById('item_detail').innerText = `${data.langFrom} to ${data.langTo}`;
                document.getElementById('item_urgency').innerText = data.urgency + " Delivery";
                document.getElementById('item_pages').innerText = data.pages;
                document.getElementById('item_price').innerText = data.totalPrice || data.price;
                document.getElementById('total_amount').innerText = data.totalPrice || data.price;

                // QR Code
                new QRCode(document.getElementById("qrcode"), {
                    text: `https://alkhatalmudie.github.io/invoice.html?id=${data.invoiceId}`,
                    width: 80, height: 80
                });

            } else {
                document.body.innerHTML = "<h1 style='color:var(--brand-navy);text-align:center;margin-top:100px;'>Invoice Not Found!</h1>";
            }
        }

        loadInvoice();
    </script>
	<script>
		window.currentInvoiceLang = 'en';

		const invoiceDictionary = {
			en: {
				invTitle: "INVOICE",
				invStatus: "<i class='fas fa-check'></i> PAID SECURELY",
				lblTo: "Invoice To",
				lblDetails: "Invoice Details",
				lblRef: "REF:",
				lblDate: "Date:",
				thDesc: "Description",
				thLang: "Languages / Region",
				thPages: "Pages",
				thTotal: "Total Amount",
				totalPaid: "Total Paid",
				footer: "This is a computer-generated document. No signature is required.<br>Encrypted by Alpha Command Security Matrix."
			},
			ar: {
				invTitle: "فاتورة",
				invStatus: "<i class='fas fa-check'></i> تم الدفع بأمان",
				lblTo: "فاتورة إلى",
				lblDetails: "تفاصيل الفاتورة",
				lblRef: "المرجع:",
				lblDate: "التاريخ:",
				thDesc: "الوصف",
				thLang: "اللغات / المنطقة",
				thPages: "الصفحات",
				thTotal: "المبلغ الإجمالي",
				totalPaid: "إجمالي المدفوع",
				footer: "هذه وثيقة تم إنشاؤها بواسطة الكمبيوتر. لا يتطلب توقيع.<br>مشفر بواسطة مصفوفة أمن القيادة الرئيسية."
			}
		};

		window.toggleInvoiceLanguage = function() {
			window.currentInvoiceLang = window.currentInvoiceLang === 'en' ? 'ar' : 'en';
			const dict = invoiceDictionary[window.currentInvoiceLang];
			const paper = document.getElementById('invoice-paper');

			// Toggle Direction
			paper.dir = window.currentInvoiceLang === 'ar' ? 'rtl' : 'ltr';
			paper.style.fontFamily = window.currentInvoiceLang === 'ar' ? "'Cairo', sans-serif" : "'Poppins', sans-serif";
			document.getElementById('btn-lang').innerText = window.currentInvoiceLang === 'en' ? 'عربي' : 'English';

			// Update UI Text
			document.getElementById('ui-inv-title').innerText = dict.invTitle;
			document.getElementById('ui-inv-status').innerHTML = dict.invStatus;
			document.getElementById('ui-lbl-to').innerText = dict.lblTo;
			document.getElementById('ui-lbl-details').innerText = dict.lblDetails;
			document.getElementById('ui-lbl-ref').innerText = dict.lblRef;
			document.getElementById('ui-lbl-date').innerText = dict.lblDate;
			document.getElementById('ui-th-desc').innerText = dict.thDesc;
			document.getElementById('ui-th-lang').innerText = dict.thLang;
			document.getElementById('ui-th-pages').innerText = dict.thPages;
			document.getElementById('ui-th-total').innerText = dict.thTotal;
			document.querySelector('.grand-total span:first-child').innerText = dict.totalPaid;
			document.getElementById('ui-inv-footer').innerHTML = dict.footer;
			
			// Adjust text alignment for RTL
			const alignment = window.currentInvoiceLang === 'ar' ? 'right' : 'left';
			const reverseAlignment = window.currentInvoiceLang === 'ar' ? 'left' : 'right';
			
			document.getElementById('ui-th-total').style.textAlign = reverseAlignment;
			document.getElementById('item_price').style.textAlign = reverseAlignment;
			document.querySelector('.info-box[style*="text-align: right"]').style.textAlign = reverseAlignment;
		};
	</script>
    <script>
        // PDF DOWNLOAD ENGINE & CUSTOM FILE NAMING
        window.downloadSecurePDF = function() {
            const btn = document.getElementById('btn-pdf');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            
            // 1. Grab the HTML paper element
            const element = document.getElementById('invoice-paper');
            
            // 2. Build the exact file name requested!
            const data = window.invoiceDataStore;
            
            // Format Date as MMDDYY (e.g., 022426)
            const d = new Date();
            const dateString = ("0" + (d.getMonth() + 1)).slice(-2) + ("0" + d.getDate()).slice(-2) + d.getFullYear().toString().slice(-2);
            
            // Handle variables
            const invIdRaw = data.invoiceId || "INV-000000";
            const idNumber = invIdRaw.replace('INV-', ''); // Extracts just the numbers
            
            const clientFormat = (data.clientName && data.clientName.trim() !== "") 
                ? data.clientName.replace(/\s+/g, '') // Removes spaces (e.g., "John Doe" -> "JohnDoe")
                : "VISITOR";
                
            const docTypeFormat = (data.docType) 
                ? data.docType.replace(/\s+/g, '').toUpperCase() 
                : "SERVICE";

            // CONSTRUCT THE EXACT REQUESTED NAME:
            // Example: [INV]-[022426]-[VISITOR]-[VISA]-[123456].pdf
            const constructedFilename = `[INV]-[${dateString}]-[${clientFormat}]-[${docTypeFormat}]-[${idNumber}].pdf`;

            // 3. Configure the PDF settings
            const opt = {
                margin:       [0, 0, 0, 0], // Top, Left, Bottom, Right
                filename:     constructedFilename,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // 4. Execute the download
            html2pdf().set(opt).from(element).save().then(() => {
                btn.innerHTML = '<i class="fas fa-file-pdf"></i> Download Secure PDF';
            });
        }
    </script>
</body>
</html>