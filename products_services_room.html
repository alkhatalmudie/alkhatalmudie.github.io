<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Package Details | Al-Khat Al-Mudi</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Cairo:wght@400;700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css">

    <style>
        body { padding-top: 100px; background-color: #0b1426; color: white; min-height: 100vh; }
        
        .showroom-grid {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        /* LEFT: VISUALS & DESC */
        .pkg-visual {
            background: linear-gradient(45deg, rgba(0, 242, 255, 0.1), rgba(255, 75, 92, 0.1));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 5rem;
            color: rgba(255,255,255,0.2);
        }

        .pkg-desc-box {
            background: rgba(255,255,255,0.05);
            padding: 30px;
            border-radius: 15px;
            border-left: 4px solid var(--brand-cyan);
        }

        /* RIGHT: DATA & CHECKOUT */
        .pkg-data-box {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(0, 242, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            position: sticky;
            top: 100px;
        }

        .sku-tag { font-family: 'Share Tech Mono'; color: var(--brand-cyan); font-size: 0.9rem; margin-bottom: 10px; display: inline-block; background: rgba(0, 242, 255, 0.1); padding: 5px 10px; border-radius: 5px; }
        
        .price-row { display: flex; align-items: baseline; gap: 15px; margin: 20px 0; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .price-old { text-decoration: line-through; color: #888; font-size: 1.2rem; }
        .price-new { color: var(--brand-cyan); font-size: 2.5rem; font-weight: 900; }

        .req-list { list-style: none; padding: 0; margin: 15px 0; }
        .req-list li { margin-bottom: 10px; font-size: 0.9rem; color: #ccc; }
        .req-list i { color: var(--brand-magenta); margin-right: 8px; }

        /* SOCIAL TELEMETRY */
        .social-hub {
            background: rgba(255,255,255,0.02);
            border-radius: 15px;
            padding: 30px;
            margin-top: 40px;
        }
        .telemetry-row { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .t-metric { font-family: 'Share Tech Mono'; font-size: 1.1rem; color: #aaa; display: flex; align-items: center; gap: 8px; }
        
        .btn-like { background: transparent; border: 1px solid var(--brand-magenta); color: var(--brand-magenta); padding: 5px 15px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .btn-like:hover, .btn-like.active { background: var(--brand-magenta); color: white; }

        .comment-box { margin-bottom: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-left: 2px solid #555; border-radius: 0 8px 8px 0; }
        .comment-author { font-weight: bold; color: var(--brand-cyan); font-size: 0.85rem; margin-bottom: 5px; }
        .comment-text { font-size: 0.9rem; color: #ddd; }

        @media (max-width: 900px) {
            .showroom-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <div class="container">
            <nav class="navbar">
                <a href="index.html" class="logo-box" style="text-decoration: none;">
                    <div class="dna-logo"><div class="dna-drop dna-magenta"></div><div class="dna-drop dna-cyan"></div></div>
                    <div class="brand-text"><h3>Al-Khat Al-Mudi</h3><span>MISSION BRIEFING</span></div>
                </a>
                <div id="user-profile-section" class="user-status-hidden">
                    <a href="profile.html" class="user-orb"><i class="fas fa-user-circle"></i><span id="user-display-name">Client</span></a>
                    <button onclick="handleLogout()" class="logout-link">Logout</button>
                </div>
            </nav>
        </div>
    </header>

    <main class="container">
        <div id="loading-ui" style="text-align: center; padding: 100px 0; color: var(--brand-cyan);">
            <i class="fas fa-satellite-dish fa-spin fa-3x"></i>
            <h3>Establishing Uplink to Target Data...</h3>
        </div>

        <div id="content-ui" style="display: none;">
            <div class="showroom-grid">
                
                <div>
                    <div class="pkg-visual"><i class="fas fa-globe-americas"></i></div>
                    <div class="pkg-desc-box">
                        <h2 id="ui-title" style="margin-top:0;">--</h2>
                        <p id="ui-desc" style="line-height: 1.8; color: #ccc;">--</p>
                        
                        <div style="margin-top: 20px; font-family: 'Share Tech Mono'; color: var(--brand-magenta);">
                            <i class="fas fa-hourglass-half"></i> Processing Time: <span id="ui-time">3-5 Business Days</span>
                        </div>
                    </div>

                    <div class="social-hub">
                        <h3 style="margin-top: 0; color: white;"><i class="fas fa-comments"></i> Field Reports & Commendations</h3>
                        <div class="telemetry-row">
                            <div class="t-metric"><i class="fas fa-eye"></i> <span id="ui-views">0</span> Visitors</div>
                            <div class="t-metric"><i class="fas fa-heart"></i> <span id="ui-likes">0</span> Commendations</div>
                            <button class="btn-like" id="btn-like" onclick="triggerLike()"><i class="fas fa-heart"></i> ENDORSE</button>
                        </div>
                        
                        <div id="comments-section">
                            </div>

                        <div style="margin-top: 20px; display: flex; gap: 10px;">
                            <input type="text" id="comment-input" placeholder="Transmit a field report..." style="flex:1; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid #555; color: white; border-radius: 5px;">
                            <button class="btn btn-primary" onclick="postComment()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="pkg-data-box">
                        <div class="sku-tag">SKU: <span id="ui-sku">--</span></div>
                        <p style="color: #ff4b5c; font-size: 0.85rem; font-weight: bold;"><i class="fas fa-clock"></i> Valid until: <span id="ui-end">--</span></p>
                        
                        <div class="price-row">
                            <span class="price-old" id="ui-old-price">$0</span>
                            <span class="price-new" id="ui-new-price">$0</span>
                        </div>

                        <h4 style="color: white; border-bottom: 1px solid #444; padding-bottom: 10px;">Required Intel (Documents)</h4>
                        <ul class="req-list" id="ui-reqs">
                            </ul>

                        <button class="btn btn-primary" style="width: 100%; font-size: 1.2rem; padding: 15px; margin-top: 20px;" onclick="initiatePurchase()">
                            SECURE THIS PACKAGE
                        </button>
                        <p style="text-align: center; font-size: 0.75rem; color: #666; margin-top: 15px;"><i class="fas fa-shield-alt"></i> 256-Bit Encrypted Transfer</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module" src="assets/js/global-auth.js"></script>
    <script type="module">
        import { getFirestore, doc, getDoc, updateDoc, increment, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const db = getFirestore(getApp());
        const auth = getAuth(getApp());

        // Extract Package ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('pkg');

        // Global target reference
        let targetRef;

        async function extractTargetData() {
            if(!targetId) { alert("ERROR: No Target Coordinates Provided."); window.location.href="index.html"; return; }
            
            targetRef = doc(db, "promotions", targetId);

            try {
                // 1. Fetch Package Data
                const docSnap = await getDoc(targetRef);
                if (!docSnap.exists()) { alert("Target package MIA or expired."); return; }
                
                const data = docSnap.data();

                // 2. Increment View Counter silently
                await updateDoc(targetRef, { views: increment(1) });

                // 3. Populate UI
                document.getElementById('ui-title').innerText = data.name;
                document.getElementById('ui-desc').innerText = data.desc;
                document.getElementById('ui-sku').innerText = `AKM-${targetId.substring(0,5).toUpperCase()}`;
                document.getElementById('ui-end').innerText = data.endDate;
                document.getElementById('ui-old-price').innerText = `$${data.oldPrice}`;
                document.getElementById('ui-new-price').innerText = `$${data.newPrice}`;
                document.getElementById('ui-views').innerText = (data.views || 0) + 1;
                document.getElementById('ui-likes').innerText = data.likes || 0;

                // Process Requirements
                const reqsHtml = data.reqs.split(',').map(item => `<li><i class="fas fa-file-contract"></i> ${item.trim()}</li>`).join('');
                document.getElementById('ui-reqs').innerHTML = reqsHtml;

                // 4. Listen for Comments in Real-Time
                const commentsQuery = query(collection(targetRef, "comments"), orderBy("timestamp", "desc"));
                onSnapshot(commentsQuery, (snapshot) => {
                    const commentsBox = document.getElementById('comments-section');
                    commentsBox.innerHTML = "";
                    if(snapshot.empty) { commentsBox.innerHTML = "<p style='color:#666; font-size:0.85rem;'>No field reports yet. Be the first.</p>"; return; }
                    
                    snapshot.forEach(cDoc => {
                        const cData = cDoc.data();
                        commentsBox.innerHTML += `
                            <div class="comment-box">
                                <div class="comment-author"><i class="fas fa-user-astronaut"></i> ${cData.author}</div>
                                <div class="comment-text">${cData.text}</div>
                            </div>
                        `;
                    });
                });

                // Swap Visibility
                document.getElementById('loading-ui').style.display = 'none';
                document.getElementById('content-ui').style.display = 'block';

            } catch (error) {
                console.error("Extraction Failed:", error);
            }
        }

        // SOCIAL FUNCTIONS attached to window
        window.triggerLike = async function() {
            const btn = document.getElementById('btn-like');
            if(btn.classList.contains('active')) return; // Already liked this session
            
            btn.classList.add('active');
            btn.innerHTML = "<i class='fas fa-check'></i> ENDORSED";
            
            const currentLikes = parseInt(document.getElementById('ui-likes').innerText);
            document.getElementById('ui-likes').innerText = currentLikes + 1;
            
            await updateDoc(targetRef, { likes: increment(1) });
        }

        window.postComment = async function() {
            const input = document.getElementById('comment-input');
            const text = input.value.trim();
            if(!text) return;

            // Check Identity
            const user = auth.currentUser;
            const authorName = user ? (user.displayName || "Verified Agent") : "Guest User";

            input.value = ""; // Clear input immediately
            
            await addDoc(collection(targetRef, "comments"), {
                author: authorName,
                text: text,
                timestamp: new Date()
            });
        }

        // CHECKOUT ROUTING (UPGRADED)
        window.initiatePurchase = function() {
            const user = auth.currentUser;
            
            // 1. If they are a civilian, route to login and pass the current URL as a tracker
            if (!user) {
                alert("ACCESS RESTRICTED: You must be a registered agent to secure this package.");
                // We encode the URL so it doesn't break when passed as a parameter
                const currentUrl = encodeURIComponent(window.location.href);
                window.location.href = `login.html?redirect=${currentUrl}`;
                return;
            }

            // 2. If they are logged in, proceed to checkout normally
            const pkgName = document.getElementById('ui-title').innerText;
            const pkgPrice = document.getElementById('ui-new-price').innerText.replace('$', ''); // Strip the $ sign
            
            const checkoutUrl = `checkout.html?doc=${encodeURIComponent(pkgName)}&from=NA&to=NA&pages=1&urgency=Priority&price=${pkgPrice} JOD&loc=Global Hub`;
            window.location.href = checkoutUrl;
        }

        // Ignite Sequence
        document.addEventListener('DOMContentLoaded', extractTargetData);
    </script>
</body>
</html>